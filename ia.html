<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"></meta>
        <title>Tarea IA</title>
        
        <link rel="stylesheet" href="./css/general.css" />  
        <link rel="stylesheet" href="./css/fluid_grid.css" />  
        <script type="text/javascript" src="./js/jquery-1.6.4.min.js"></script>
        <script type="text/javascript" src="./js/jquery.tmpl.js"></script>
        <script type="text/javascript" src="./js/knockout-1.2.1.js"></script>
        

    </head>
    <body>
        <div id="container">
            <div id="header" >
                <center><h1>Trabajo de IA </h1></center>
            </div>
            <div class="container_12">
            <div id="dashboard" class="grid_3">
		        <table >
		            <tbody>
		                <tr>
		                    <td>
		                        <span class="spantext">Robot X:</span>
		                    </td>
		                    <td>
		                      <input type="text" class="inputform" data-bind="value:robot_x"/>
		                    </td>
		                    <td>
		                      <input type="text" class="inputform" data-bind="value:robot_y"/>
		                    </td>

		                </tr>
		                <tr>
		                </tr>
		                <tr>
		                    <td>
		                        <span class="spantext">Objeto1 X:</span>
		                    </td>
		                    <td>
		                        <input type="text" class="inputform" data-bind="value:objeto1_x"/>
		                    </td>
		                      
		                    <td>
		                      <input type="text" class="inputform" data-bind="value:objeto1_y"/>
		                    </td>
		                    <td><span data-bind=' visible: cuadro_visible().recogido_o1'>[IMG]</span></td>
		                </tr>
		                
		                <tr>
		                    <td>
		                        <span class="spantext">Objeto2 X:</span>
		                    </td>
		                    <td>
		                        <input type="text" class="inputform" data-bind="value:objeto2_x"/>
		                    </td>
		                    <td>
                                <input type="text" class="inputform" data-bind="value:objeto2_y"/>
                            </td>
                            <td><span data-bind=' visible: cuadro_visible().recogido_o2'>[IMG]</span></td>
		                </tr>
		                
		                <tr>
		                    <td>
		                        <span class="spantext">Objeto3 X:</span>
		                    </td>
		                    

		                    <td>
                              <input type="text" class="inputform" data-bind="value:objeto3_x"/>
                            </td>    
                            <td>
                                <input type="text" class="inputform" data-bind="value:objeto3_y"/>
                            </td>
                            <td><span data-bind=' visible: cuadro_visible().recogido_o3'>[IMG]</span></td>
		                </tr>
		            </tbody>
		        </table>

                <select data-bind='options: metodos, optionsValue:"opcion", optionsText:"metodo", value: metodoSeleccionado'></select>

		        <button data-bind="click:function(){cargar()}">Recargar</button>

		    </div>
		    <div class="grid_6">
	           <div data-bind="template: {name:'cuadro', data:cuadro_visible()}" id="tablero"></div>
	           <br/>
	           <center><a class="button pequeno rojo" href="#"><span data-bind="click:function(){solucion()}">START !</span></a></center>
	        </div>
	        <div id="log" class="grid_3">
	           <textarea rows="28" cols="35"></textarea>
	        </div>
            </div>

            <script type="text/html" id="cuadro">
        
                <table id="tablarobot" align="center">
                <tbody>
                {{each(i, linea) c}}
                    <tr>
                        {{each(j, columna) linea}}
                            <td>
                                <img id="img" data-bind="attr:{src:columna}">
                            </td>
                        {{/each}}
                    
                    </tr>
                {{/each}}
                </tbody>
                </table>
            </script>
        <div class="push"></div>
        </div>  
        <div class="footer">
            Tarea de IA</br>
            Integrantes: CÃ©sar Toro - Cristian Arteaga
        </div>
        
        <script type="text/javascript">
        
            function pause(numberMillis) 
            {
                var now = new Date();
                var exitTime = now.getTime() + numberMillis;
                while (true) 
                {
                now = new Date();
                if (now.getTime() > exitTime)
                return;
                }
            }	
            var cuadro_visual = function(robot_x, robot_y, objeto1_x, objeto1_y, objeto2_x, objeto2_y, objeto3_x, objeto3_y,recogido_o1,recogido_o2,recogido_o3){
                this.robot_x = ko.observable(robot_x);
                this.robot_y = ko.observable(robot_y);
                this.objeto1_x = ko.observable(objeto1_x);
                this.objeto1_y = ko.observable(objeto1_y);
                this.objeto2_x = ko.observable(objeto2_x);
                this.objeto2_y = ko.observable(objeto2_y);
                this.objeto3_x = ko.observable(objeto3_x);
                this.objeto3_y = ko.observable(objeto3_y);
                this.recogido_o1 = ko.observable(recogido_o1);
                this.recogido_o2 = ko.observable(recogido_o2);
                this.recogido_o3 = ko.observable(recogido_o3);
                this.c = ko.dependentObservable(function(){
                    console.log("dependentObservable");
                    var c = new Array;
                    var recogido = 0;
                    for(i=1; i<=4; i++){
                        c[i-1] = new Array;
                        
                        for(j=1; j<=4; j++){
                            c[i-1][j-1] = "./imagenes/vacio.jpg";
                            
                            if(this.objeto1_x() == i && this.objeto1_y() == j){
                                c[i-1][j-1] = "./imagenes/objeto1.jpg";
                                if(this.recogido_o1())
                                    recogido++;
                            }
                            if(this.objeto2_x() == i && this.objeto2_y() == j){
                                c[i-1][j-1] = "./imagenes/objeto2.jpg";
                                if(this.recogido_o2())
                                    recogido++;
                            }
                            if(this.objeto3_x() == i && this.objeto3_y() == j){
                                c[i-1][j-1] = "./imagenes/objeto3.jpg";
                                if(this.recogido_o3())
                                    recogido++;
                            }
                            if(this.robot_x() == i && this.robot_y() == j){
                                c[i-1][j-1] = "./imagenes/robot-vacio.jpg";
                                if(recogido==1)
                                    c[i-1][j-1] = "./imagenes/robot-1o.jpg";
                                if(recogido==2)
                                    c[i-1][j-1] = "./imagenes/robot-2o.jpg";
                                if(recogido==3)
                                    c[i-1][j-1] = "./imagenes/robot-3o.jpg";
                                    //this.c[i-1][j-1] = "R"+recogido;
                            }
                        }
                    }
                    return c;
                },this);

            };
            
            var cuadro_nodo = function(robot_x, robot_y, objeto1_x, objeto1_y, objeto2_x, objeto2_y, objeto3_x, objeto3_y, altura,ruta,operador) {
                
                this.robot_x = robot_x;
                this.robot_y = robot_y;
                this.objeto1_x = objeto1_x;
                this.objeto1_y = objeto1_y;
                this.objeto2_x = objeto2_x;
                this.objeto2_y = objeto2_y;
                this.objeto3_x = objeto3_x;
                this.objeto3_y = objeto3_y;
                this.recogido_o1 = false;
                this.recogido_o2 = false;
                this.recogido_o3 = false;
                this.altura = altura;
                this.expandido = false;
                this.ruta = new Array;
                var mapeo = $.map(ruta, function(oper){
                    return oper;
                })
                this.ruta = mapeo;
                this.ruta.push(operador);
                this.costo = 0;
            };
            
            /*
            
                Opedarores:
                    - 0  : ningun operador;
                    - 1  : mover Norte
                    - 2  : mover Sur
                    - 3  : mover Este
                    - 4  : mover Oeste
                
                En la ruta se almacenan los operadores que llevan al robot a esa situacion.
            */
            
            var lecturas = function() {
                this.metodos = ko.observableArray([{metodo:"A* h1",opcion:1},{metodo:"A* h2",opcion:1},{metodo:"IDA*",opcion:1}]);
                this.metodoSeleccionado = ko.observable();
                this.cuadro_visible = ko.observable();
                this.cuadro_inicial = ko.observable();
                this.arbol = ko.observableArray([]);
                this.ruta_solucion = ko.observableArray([]);
                this.robot_x = ko.observable(1);
                this.robot_y = ko.observable(1);
                this.objeto1_x = ko.observable(3);
                this.objeto1_y = ko.observable(1);
                this.objeto2_x = ko.observable(4);
                this.objeto2_y = ko.observable(2);
                this.objeto3_x = ko.observable(2);
                this.objeto3_y = ko.observable(4);
                this.recogido_o1 = ko.observable(false);
                this.recogido_o2 = ko.observable(false);
                this.recogido_o3 = ko.observable(false);
                this.cuadro_visible(new cuadro_visual(this.robot_x(),this.robot_y(),this.objeto1_x(),this.objeto1_y(),this.objeto2_x(),this.objeto2_y(), this.objeto3_x(), this.objeto3_y(),false,false,false));
                this.cuadro_inicial(new cuadro_nodo(this.robot_x(),this.robot_y(),this.objeto1_x(),this.objeto1_y(),this.objeto2_x(),this.objeto2_y(), this.objeto3_x(), this.objeto3_y(),0,new Array,0));
                //alert(ko.toJSON(this.niveles()));
                this.arbol.push(this.cuadro_inicial());
                this.cargar = function(){
                    this.cuadro_inicial(new cuadro_nodo(this.robot_x(),this.robot_y(),this.objeto1_x(),this.objeto1_y(),this.objeto2_x(),this.objeto2_y(), this.objeto3_x(), this.objeto3_y(),0,new Array,0));
                    this.arbol.removeAll();
                    this.arbol.push(this.cuadro_inicial());
                    this.ruta_solucion.removeAll();
                    this.recogido_o1(false);
                    this.recogido_o2(false);
                    this.recogido_o3(false);
                    this.cuadro_visible(new cuadro_visual(this.robot_x(),this.robot_y(),this.objeto1_x(),this.objeto1_y(),this.objeto2_x(),this.objeto2_y(), this.objeto3_x(), this.objeto3_y()));
                    alert(ko.toJSON(this));
                };
                
                this.solucion = function(){
                    this.cargar();
                    var largo = this.arbol().length;
                    while(!this.terminado()){
                        menor = this.menor_costo();
                        if(!this.arbol()[menor].expandido){
                            this.mover_norte(this.arbol()[menor]);
                            this.mover_sur(this.arbol()[menor]);
                            this.mover_este(this.arbol()[menor]);
                            this.mover_oeste(this.arbol()[menor]);
                            this.arbol()[menor].expandido = true;
                        }
                        else{
                            alert("No existe una solucion posible");
                            break;
                            
                        }
                        //alert(ko.toJSON(this.arbol()));
                    }
                    
                    alert(ko.toJSON(this.ruta_solucion()));
                    this.mostrar_solucion();
                };
                
                this.mostrar_solucion = function(){
                    var largo = this.ruta_solucion().length;
                    for(var i=0;i<largo;i++){
                        //alert(ko.toJSON(this.cuadro_visible()));
                        if(this.ruta_solucion()[i]==1){
                            //mover a al norte
                            this.cuadro_visible().robot_x(this.cuadro_visible().robot_x()-1);
                            
                            if(this.cuadro_visible().recogido_o1())
                                this.cuadro_visible().objeto1_x(this.cuadro_visible().objeto1_x()-1);
                            if(this.cuadro_visible().recogido_o2())
                                this.cuadro_visible().objeto2_x(this.cuadro_visible().objeto2_x()-1);
                            if(this.cuadro_visible().recogido_o3())
                                this.cuadro_visible().objeto3_x(this.cuadro_visible().objeto3_x()-1);
                            
                            this.recoger_objeto_visible(this.cuadro_visible());
                        }
                        if(this.ruta_solucion()[i]==2){
                            //mover a al Sur
                            this.cuadro_visible().robot_x(this.cuadro_visible().robot_x()+1);
                            
                            if(this.cuadro_visible().recogido_o1())
                                this.cuadro_visible().objeto1_x(this.cuadro_visible().objeto1_x()+1);
                            if(this.cuadro_visible().recogido_o2())
                                this.cuadro_visible().objeto2_x(this.cuadro_visible().objeto2_x()+1);
                            if(this.cuadro_visible().recogido_o3())
                                this.cuadro_visible().objeto3_x(this.cuadro_visible().objeto3_x()+1);
                            
                            this.recoger_objeto_visible(this.cuadro_visible());
                        }
                        if(this.ruta_solucion()[i]==3){
                            //mover a al Este
                            this.cuadro_visible().robot_y(this.cuadro_visible().robot_y()+1);
                            
                            if(this.cuadro_visible().recogido_o1())
                                this.cuadro_visible().objeto1_y(this.cuadro_visible().objeto1_y()+1);
                            if(this.cuadro_visible().recogido_o2())
                                this.cuadro_visible().objeto2_y(this.cuadro_visible().objeto2_y()+1);
                            if(this.cuadro_visible().recogido_o3())
                                this.cuadro_visible().objeto3_y(this.cuadro_visible().objeto3_y()+1);
                            
                            this.recoger_objeto_visible(this.cuadro_visible());
                        }
                        if(this.ruta_solucion()[i]==4){
                            //mover a al Oeste
                            this.cuadro_visible().robot_y(this.cuadro_visible().robot_y()-1);
                            
                            if(this.cuadro_visible().recogido_o1())
                                this.cuadro_visible().objeto1_y(this.cuadro_visible().objeto1_y()-1);
                            if(this.cuadro_visible().recogido_o2())
                                this.cuadro_visible().objeto2_y(this.cuadro_visible().objeto2_y()-1);
                            if(this.cuadro_visible().recogido_o3())
                                this.cuadro_visible().objeto3_y(this.cuadro_visible().objeto3_y()-1);
                            
                            this.recoger_objeto_visible(this.cuadro_visible());
                        }
                        //
                        console.log(i);
                        //pause(500);
                    };
                    alert(ko.toJSON(this.cuadro_visible()));
                };
                
                this.recoger_objeto_visible = function(cuadro){
                    if(!cuadro.recogido_o1())
                        if(cuadro.robot_x()==cuadro.objeto1_x()&&cuadro.robot_y()==cuadro.objeto1_y())
                            cuadro.recogido_o1(true);
                            
                    if(!cuadro.recogido_o2())
                        if(cuadro.robot_x()==cuadro.objeto2_x()&&cuadro.robot_y()==cuadro.objeto2_y())
                            cuadro.recogido_o2(true);
                            
                    if(!cuadro.recogido_o3())
                        if(cuadro.robot_x()==cuadro.objeto3_x()&&cuadro.robot_y()==cuadro.objeto3_y())
                            cuadro.recogido_o3(true);
                };
                
                this.terminado = function(){
                    var largo = this.arbol().length;
                    for(i=0;i<largo;i++){
                        if(this.arbol()[i].recogido_o1&&this.arbol()[i].recogido_o2&&this.arbol()[i].recogido_o3){
                            this.ruta_solucion(this.arbol()[i].ruta);
                            return true;
                        }
                    }
                    return false;
                };
                
                this.menor_costo = function(){
                    var largo = this.arbol().length;
                    var menor = 0;
                    for(i=0;i<largo;i++){
                        if(this.arbol()[menor].expandido&&!this.arbol()[i].expandido){
                            var menor = i;
                        }
                        if(this.arbol()[i].costo<this.arbol()[menor].costo&&!this.arbol()[i].expandido){
                            var menor = i;
                        }
                    }
                    return menor;
                };
                
                this.costo_ruta = function(cuadro){
                    if(this.metodoSeleccionado()==1)
                        return this.costo_ruta_1(cuadro);
                    if(this.metodoSeleccionado()==2)
                        return this.costo_ruta_2(cuadro);
                    if(this.metodoSeleccionado()==3)
                        return this.costo_ruta_3(cuadro);
                };
                
                this.costo_ruta_1 = function(cuadro){
                    return cuadro.costo + 1;
                };
                this.costo_ruta_2 = function(cuadro){
                    
                    return cuadro.costo + 2;
                };
                this.costo_ruta_3 = function(cuadro){
                    return cuadro.costo + 3;
                
                };
                
                this.recoger_objeto = function(cuadro){
                    if(!cuadro.recogido_o1)
                        if(cuadro.robot_x==cuadro.objeto1_x&&cuadro.robot_y==cuadro.objeto1_y)
                            cuadro.recogido_o1 = true;
                            
                    if(!cuadro.recogido_o2)
                        if(cuadro.robot_x==cuadro.objeto2_x&&cuadro.robot_y==cuadro.objeto2_y)
                            cuadro.recogido_o2 = true;
                            
                    if(!cuadro.recogido_o3)
                        if(cuadro.robot_x==cuadro.objeto3_x&&cuadro.robot_y==cuadro.objeto3_y)
                            cuadro.recogido_o3 = true;
                };
                
                this.mover_este = function(cuadro){
                    if(cuadro.robot_y<4&&this.verificar_orden(cuadro.robot_x,cuadro.robot_y+1, cuadro)){
                        var objeto1_y = cuadro.objeto1_y;
                        var objeto2_y = cuadro.objeto2_y;
                        var objeto3_y = cuadro.objeto3_y;
                        
                        if(cuadro.recogido_o1)
                            objeto1_y = parseInt(cuadro.objeto1_y)+1;
                            
                        if(cuadro.recogido_o2)
                            objeto2_y = parseInt(cuadro.objeto2_y)+1;
                            
                        if(cuadro.recogido_o3)
                            objeto3_y = parseInt(cuadro.objeto3_y)+1;
                            
                                                
                        nuevo_cuadro = new cuadro_nodo(cuadro.robot_x,cuadro.robot_y+1,cuadro.objeto1_x,objeto1_y,cuadro.objeto2_x,objeto2_y, cuadro.objeto3_x, objeto3_y,cuadro.altura+1,cuadro.ruta,3);
                        nuevo_cuadro.costo = this.costo_ruta(nuevo_cuadro);
                        this.recoger_objeto(nuevo_cuadro);
                        this.arbol.push(nuevo_cuadro);
                        
                    }
                    else
                        console.log("no se puede mover a la este");
                    
                };
                this.mover_oeste = function(cuadro){
                    if(cuadro.robot_y>1&&this.verificar_orden(cuadro.robot_x,cuadro.robot_y-1, cuadro)){
                        var objeto1_y = cuadro.objeto1_y;
                        var objeto2_y = cuadro.objeto2_y;
                        var objeto3_y = cuadro.objeto3_y;
                        
                        if(cuadro.recogido_o1)
                            objeto1_y = parseInt(cuadro.objeto1_y)-1;
                            
                        if(cuadro.recogido_o2)
                            objeto2_y = parseInt(cuadro.objeto2_y)-1;
                            
                        if(cuadro.recogido_o3)
                            objeto3_y = parseInt(cuadro.objeto3_y)-1;
                                
                        nuevo_cuadro = new cuadro_nodo(cuadro.robot_x,cuadro.robot_y-1,cuadro.objeto1_x,objeto1_y,cuadro.objeto2_x,objeto2_y, cuadro.objeto3_x, objeto3_y,cuadro.altura+1,cuadro.ruta,4);
                        nuevo_cuadro.costo = this.costo_ruta(nuevo_cuadro);
                        this.recoger_objeto(nuevo_cuadro);
                        this.arbol.push(nuevo_cuadro);
                        
                    }
                    else
                        console.log("no se puede mover a la oeste");
                    
                };
                
                this.mover_sur = function(cuadro){
                    if(cuadro.robot_x<4&&this.verificar_orden(cuadro.robot_x+1,cuadro.robot_y, cuadro)){
                        var objeto1_x = cuadro.objeto1_x;
                        var objeto2_x = cuadro.objeto2_x;
                        var objeto3_x = cuadro.objeto3_x;
                        if(cuadro.recogido_o1)
                            objeto1_x = parseInt(cuadro.objeto1_x)+1;
                            
                        if(cuadro.recogido_o2)
                            objeto2_x = parseInt(cuadro.objeto2_x)+1;
                            
                        if(cuadro.recogido_o3)
                            objeto3_x = parseInt(cuadro.objeto3_x)+1;
                            
                        nuevo_cuadro = new cuadro_nodo(cuadro.robot_x+1,cuadro.robot_y,objeto1_x,cuadro.objeto1_y,objeto2_x,cuadro.objeto2_y, objeto3_x, cuadro.objeto3_y,cuadro.altura+1,cuadro.ruta,2);
                        nuevo_cuadro.costo = this.costo_ruta(nuevo_cuadro);
                        this.recoger_objeto(nuevo_cuadro);
                        this.arbol.push(nuevo_cuadro);
                        
                    }
                    else
                        console.log("no se puede mover a la sur");
                    
                };
                
                
                this.mover_norte = function(cuadro){
                    if(cuadro.robot_x>1&&this.verificar_orden(cuadro.robot_x-1,cuadro.robot_y, cuadro)){
                        var objeto1_x = cuadro.objeto1_x;
                        var objeto2_x = cuadro.objeto2_x;
                        var objeto3_x = cuadro.objeto3_x;
                        
                        if(cuadro.recogido_o1)
                            objeto1_x = parseInt(cuadro.objeto1_x)-1;
                            
                        if(cuadro.recogido_o2)
                            objeto2_x = parseInt(cuadro.objeto2_x)-1;
                            
                        if(cuadro.recogido_o3)
                            objeto3_x = parseInt(cuadro.objeto3_x)-1;
                        
                        nuevo_cuadro = new cuadro_nodo(cuadro.robot_x-1,cuadro.robot_y,objeto1_x,cuadro.objeto1_y,objeto2_x,cuadro.objeto2_y, objeto3_x, cuadro.objeto3_y,cuadro.altura+1,cuadro.ruta,1);
                        this.recoger_objeto(nuevo_cuadro);
                        nuevo_cuadro.costo = this.costo_ruta(nuevo_cuadro);
                        this.arbol.push(nuevo_cuadro);
                        
                    }
                    else
                        console.log("no se puede mover a la norte");
                    
                };
                
                				
				this.verificar_orden = function(robot_x, robot_y, cuadro){
					if(robot_x==cuadro.objeto2_x&&robot_y==cuadro.objeto2_y&&!cuadro.recogido_o1)
						return false;
					if(robot_x==cuadro.objeto3_x&&robot_y==cuadro.objeto3_y&&!cuadro.recogido_o2)
						return false;
                    return true;
                };
				
				
               
            };
             
            var lectViewModel = new lecturas();
            ko.applyBindings(lectViewModel);
            

        </script>

    </body>
</html>

